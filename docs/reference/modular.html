<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Modular functions for mixed model fits"><title>Modular Functions for Mixed Model Fits — modular • lme4</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Modular Functions for Mixed Model Fits — modular"><meta property="og:description" content="Modular functions for mixed model fits"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">lme4</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1-35.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/lmerperf.html">lme4 performance tips</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/lme4/lme4/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Modular Functions for Mixed Model Fits</h1>
      
      <div class="d-none name"><code>modular.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Modular functions for mixed model fits</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">lFormula</span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="cn">NULL</span>, REML <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    <span class="va">subset</span>, <span class="va">weights</span>, <span class="va">na.action</span>, <span class="va">offset</span>, contrasts <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="lmerControl.html">lmerControl</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mkLmerDevfun</span><span class="op">(</span><span class="va">fr</span>, <span class="va">X</span>, <span class="va">reTrms</span>, REML <span class="op">=</span> <span class="cn">TRUE</span>, start <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0</span>, control <span class="op">=</span> <span class="fu"><a href="lmerControl.html">lmerControl</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">optimizeLmer</span><span class="op">(</span><span class="va">devfun</span>,</span>
<span>             optimizer    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">lmerControl</span><span class="op">)</span><span class="op">$</span><span class="va">optimizer</span>,</span>
<span>             restart_edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">lmerControl</span><span class="op">)</span><span class="op">$</span><span class="va">restart_edge</span>,</span>
<span>             boundary.tol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">lmerControl</span><span class="op">)</span><span class="op">$</span><span class="va">boundary.tol</span>,</span>
<span>             start <span class="op">=</span> <span class="cn">NULL</span>, verbose <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>             control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">glFormula</span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="cn">NULL</span>, family <span class="op">=</span> <span class="va">gaussian</span>,</span>
<span>    <span class="va">subset</span>, <span class="va">weights</span>, <span class="va">na.action</span>, <span class="va">offset</span>, contrasts <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">start</span>, <span class="va">mustart</span>, <span class="va">etastart</span>, control <span class="op">=</span> <span class="fu"><a href="lmerControl.html">glmerControl</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mkGlmerDevfun</span><span class="op">(</span><span class="va">fr</span>, <span class="va">X</span>, <span class="va">reTrms</span>, <span class="va">family</span>, nAGQ <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>              verbose <span class="op">=</span> <span class="fl">0L</span>, maxit <span class="op">=</span> <span class="fl">100L</span>, control <span class="op">=</span> <span class="fu"><a href="lmerControl.html">glmerControl</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">optimizeGlmer</span><span class="op">(</span><span class="va">devfun</span>,</span>
<span>    optimizer <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">stage</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="st">"bobyqa"</span> <span class="kw">else</span> <span class="st">"Nelder_Mead"</span>,</span>
<span>    restart_edge <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    boundary.tol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">glmerControl</span><span class="op">)</span><span class="op">$</span><span class="va">boundary.tol</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0L</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    nAGQ <span class="op">=</span> <span class="fl">1L</span>, stage <span class="op">=</span> <span class="fl">1</span>, start <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">updateGlmerDevfun</span><span class="op">(</span><span class="va">devfun</span>, <span class="va">reTrms</span>, nAGQ <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>formula</dt>
<dd><p>a two-sided linear formula object
    describing both the fixed-effects and random-effects parts
    of the model, with the response on the left of a <code>~</code>
    operator and the terms, separated by <code>+</code> operators,
    on the right.  Random-effects terms are distinguished by
    vertical bars (<code>"|"</code>) separating expressions for
    design matrices from grouping factors.</p></dd>


  <dt>data</dt>
<dd><p>an optional data frame containing the
    variables named in <code>formula</code>.  By default the
    variables are taken from the environment from which
    <code>lmer</code> is called. While <code>data</code> is optional, the
    package authors <em>strongly</em> recommend its use,
    especially when later applying methods such as
    <code>update</code> and <code>drop1</code> to the fitted model
    (<em>such methods are not guaranteed to work properly
      if <code>data</code> is omitted</em>). If <code>data</code> is omitted,
    variables will be taken from the environment of
    <code>formula</code> (if specified as a formula) or from the
    parent frame (if specified as a character vector).</p></dd>


  <dt>REML</dt>
<dd><p>(logical) indicating to fit <b>re</b>stricted maximum
    likelihood model.</p></dd>


  <dt>subset</dt>
<dd><p>an optional expression indicating the
    subset of the rows of <code>data</code> that should be used in
    the fit. This can be a logical vector, or a numeric
    vector indicating which observation numbers are to be
    included, or a character vector of the row names to be
    included.  All observations are included by default.</p></dd>


  <dt>weights</dt>
<dd><p>an optional vector of ‘prior weights’ to be used
    in the fitting process.  Should be <code>NULL</code> or a numeric vector.</p></dd>


  <dt>na.action</dt>
<dd><p>a function that indicates what should
    happen when the data contain <code>NA</code>s.  The default
    action (<code>na.omit</code>, inherited from the 'factory
    fresh' value of <code>getOption("na.action")</code>) strips any
    observations with any missing values in any variables.</p></dd>


  <dt>offset</dt>
<dd><p>this can be used to specify an <em>a priori</em> known
    component to be included in the linear predictor during
    fitting.  This should be <code>NULL</code> or a numeric vector of length
    equal to the number of cases.  One or more <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></code>
    terms can be included in the formula instead or as well, and if
    more than one is specified their sum is used.  See
    <code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.offset</a></code>.</p></dd>


  <dt>contrasts</dt>
<dd><p>an optional <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></code>.  See the
    <code>contrasts.arg</code> of <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix.default</a></code>.</p></dd>


  <dt>control</dt>
<dd><p>a list giving</p><dl><dt>for <code>[g]lFormula</code>:</dt>
<dd><p>all
	options for running the model, see <code><a href="lmerControl.html">lmerControl</a></code>;</p></dd>

      <dt>for <code>mkLmerDevfun,mkGlmerDevfun</code>:</dt>
<dd><p>options
	for the inner optimization step;</p></dd>

      <dt>for <code>optimizeLmer</code> and <code>optimizeGlmer</code>:</dt>
<dd><p>control
	parameters for nonlinear optimizer (typically inherited from the
	... argument to <code><a href="lmerControl.html">lmerControl</a></code>).</p></dd>

	% FIXME: reference optCtrl
    
</dl><p></p></dd>

  <dt>fr</dt>
<dd><p>A model frame containing the variables needed to create an
    <code><a href="lmResp.html">lmerResp</a></code> or <code><a href="lmResp.html">glmResp</a></code> instance.</p></dd>

  <dt>X</dt>
<dd><p>fixed-effects design matrix</p></dd>

  <dt>reTrms</dt>
<dd><p>information on random effects structure (see
    <code><a href="mkReTrms.html">mkReTrms</a></code>).</p></dd>

  <dt>start</dt>
<dd><p>starting values (see <code><a href="lmer.html">lmer</a></code>;
    for <code>glFormula</code>, should be just a numeric vector of
    fixed-effect coefficients)</p></dd>

  <dt>verbose</dt>
<dd><p>print output?</p></dd>

  <dt>maxit</dt>
<dd><p>maximal number of Pwrss update iterations.</p></dd>

  <dt>devfun</dt>
<dd><p>a deviance function, as generated by <code>mkLmerDevfun</code></p></dd>

  <dt>nAGQ</dt>
<dd><p>number of Gauss-Hermite quadrature points</p></dd>

  <dt>stage</dt>
<dd><p>optimization stage (1: nAGQ=0, optimize over theta only;
    2: nAGQ possibly &gt;0, optimize over theta and beta)</p></dd>

  <dt>optimizer</dt>
<dd><p>character - name of optimizing
    function(s).  A character vector or list of functions:
    length 1 for <code>lmer</code> or <code>glmer</code>, possibly length
    2 for <code>glmer</code>.  The built-in optimizers are
    <code>"<a href="Nelder_Mead.html">Nelder_Mead</a>"</code> and <code>"<a href="https://rdrr.io/pkg/minqa/man/bobyqa.html" class="external-link">bobyqa</a>"</code>
    (from the <a href="https://CRAN.R-project.org/package=minqa" class="external-link"><span class="pkg">minqa</span></a> package).  Any minimizing function
    that allows box constraints can be used provided that it</p><ol><li><p>takes input parameters <code>fn</code> (function to be
	optimized), <code>par</code> (starting parameter values),
	<code>lower</code> (lower bounds) and <code>control</code> (control
	parameters, passed through from the <code>control</code>
	argument) and</p></li>
<li><p>returns a list with (at least) elements
	<code>par</code> (best-fit parameters), <code>fval</code> (best-fit
	function value), <code>conv</code> (convergence code) and
	(optionally) <code>message</code> (informational message, or
	explanation of convergence failure).</p></li>
</ol><p>Special provisions are made for <code><a href="https://rdrr.io/pkg/nloptr/man/bobyqa.html" class="external-link">bobyqa</a></code>,
    <code><a href="Nelder_Mead.html">Nelder_Mead</a></code>, and optimizers wrapped in the
    <a href="https://CRAN.R-project.org/package=optimx" class="external-link"><span class="pkg">optimx</span></a> package; to use <span class="pkg">optimx</span> optimizers
    (including <code>L-BFGS-B</code> from base <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>
    and <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></code>), pass the <code>method</code>
    argument to <code>optim</code> in the <code>control</code> argument.</p>
<p>For <code>glmer</code>, if <code>length(optimizer)==2</code>, the
    first element will be used for the preliminary (random
    effects parameters only) optimization, while the second
    will be used for the final (random effects plus fixed
    effect parameters) phase. See <code>modular</code> for
    more information on these two phases.</p></dd>

  <dt>restart_edge</dt>
<dd><p>see <code><a href="lmerControl.html">lmerControl</a></code></p></dd>

  <dt>boundary.tol</dt>
<dd><p>see <code><a href="lmerControl.html">lmerControl</a></code></p></dd>

  <dt>family</dt>
<dd><p>a GLM family; see <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></code>
    and <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">family</a></code>.</p></dd>

  <dt>mustart</dt>
<dd><p>optional starting values on the scale of
    the conditional mean; see <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></code> for details.</p></dd>

  <dt>etastart</dt>
<dd><p>optional starting values on the scale of
    the unbounded predictor; see <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></code> for details.</p></dd>

  <dt>...</dt>
<dd><p>other potential arguments; for <code>optimizeLmer</code> and
    <code>optimizeGlmer</code>, these are passed to internal function
    <code>optwrap</code>, which has relevant parameters <code>calc.derivs</code>
    and <code>use.last.params</code> (see <code><a href="lmerControl.html">lmerControl</a></code>).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p></p>
<p><code>lFormula</code> and <code>glFormula</code> return a list containing
  components:</p>
<p></p>
<dl><dt>fr</dt>
<dd><p>model frame</p></dd>

     <dt>X</dt>
<dd><p>fixed-effect design matrix</p></dd>

     <dt>reTrms</dt>
<dd><p>list containing information on random effects structure:
     result of <code><a href="mkReTrms.html">mkReTrms</a></code></p></dd>

     <dt>REML</dt>
<dd><p>(lFormula only): logical indicating if restricted maximum
     likelihood was used (Copy of argument.)</p></dd>

  
</dl><p></p>
<p><code>mkLmerDevfun</code> and <code>mkGlmerDevfun</code> return a function to
      calculate deviance (or restricted deviance) as a function of the
      theta (random-effect) parameters.  <code>updateGlmerDevfun</code></p>


<p>returns a function to calculate the deviance as a function of a
      concatenation of theta and beta (fixed-effect) parameters. These
      deviance functions have an environment containing objects required
      for their evaluation. CAUTION: The <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></code> of
      functions returned by <code>mk(Gl|L)merDevfun</code> contains reference
      class objects (see <code><a href="https://rdrr.io/r/methods/refClass.html" class="external-link">ReferenceClasses</a></code>,</p>
<p></p>
<p><code><a href="merPredD-class.html">merPredD-class</a></code>, <code><a href="lmResp-class.html">lmResp-class</a></code>), which
      behave in ways that may surprise many users. For example, if the
      output of <code>mk(Gl|L)merDevfun</code> is naively copied, then
      modifications to the original will also appear in the copy (and
      vice versa). To avoid this behavior one must make a deep copy (see</p>
<p></p>
<p><code><a href="https://rdrr.io/r/methods/refClass.html" class="external-link">ReferenceClasses</a></code> for details).</p>
<p></p>
<p><code>optimizeLmer</code> and <code>optimizeGlmer</code> return the results of an
  optimization.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>These functions make up the internal components of an [gn]lmer fit.</p><ul><li><p><code>[g]lFormula</code> takes the arguments that would normally be
    passed to <code>[g]lmer</code>, checking for errors and processing the
    formula and data input to create a list of objects required to fit a
    mixed model.</p></li>
<li><p><code>mk(Gl|L)merDevfun</code> takes the output of the previous
    step (minus the <code>formula</code> component) and creates a
    deviance function</p></li>
<li><p><code>optimize(Gl|L)mer</code> takes a
    deviance function and optimizes over <code>theta</code> (or
    over <code>theta</code> and <code>beta</code>, if <code>stage</code> is set
    to 2 for <code>optimizeGlmer</code></p></li>
<li><p><code>updateGlmerDevfun</code> takes the first stage of a GLMM
    optimization (with <code>nAGQ=0</code>, optimizing over <code>theta</code> only)
    and produces a second-stage deviance function</p></li>
<li><p><code><a href="mkMerMod.html">mkMerMod</a></code> takes the <em>environment</em> of a
    deviance function, the results of an optimization, a list of
    random-effect terms, a model frame, and a model all and produces a
    <code>[g]lmerMod</code> object.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">### Fitting a linear mixed model in 4 modularized steps</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## 1.  Parse the data and formula:</span></span></span>
<span class="r-in"><span><span class="va">lmod</span> <span class="op">&lt;-</span> <span class="fu">lFormula</span><span class="op">(</span><span class="va">Reaction</span> <span class="op">~</span> <span class="va">Days</span> <span class="op">+</span> <span class="op">(</span><span class="va">Days</span><span class="op">|</span><span class="va">Subject</span><span class="op">)</span>, <span class="va">sleepstudy</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">lmod</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "fr"      "X"       "reTrms"  "REML"    "formula" "wmsgs"  </span>
<span class="r-in"><span><span class="co">## 2.  Create the deviance function to be optimized:</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">devfun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">mkLmerDevfun</span>, <span class="va">lmod</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> function (theta) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> .Call(lmer_Deviance, pp$ptr(), resp$ptr(), as.double(theta))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x000001de54c80690&gt;</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span><span class="op">)</span> <span class="co"># the environment of 'devfun' contains objects</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "lmer_Deviance" "lower"         "pp"            "resp"         </span>
<span class="r-in"><span>                        <span class="co"># required for its evaluation</span></span></span>
<span class="r-in"><span><span class="co">## 3.  Optimize the deviance function:</span></span></span>
<span class="r-in"><span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu">optimizeLmer</span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">opt</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $par</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.96674177 0.01516906 0.23090995</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $fval</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 1743.628</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $feval</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 43</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="co">## 4.  Package up the results:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="mkMerMod.html">mkMerMod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span>, <span class="va">opt</span>, <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span>, fr <span class="op">=</span> <span class="va">lmod</span><span class="op">$</span><span class="va">fr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Linear mixed model fit by REML ['lmerMod']</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> REML criterion at convergence: 1743.628</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Random effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Groups   Name        Std.Dev. Corr</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Subject  (Intercept) 24.741       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           Days         5.922   0.07</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Residual             25.592       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of obs: 180, groups:  Subject, 18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fixed Effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)         Days  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      251.41        10.47  </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Same model in one line</span></span></span>
<span class="r-in"><span><span class="fu"><a href="lmer.html">lmer</a></span><span class="op">(</span><span class="va">Reaction</span> <span class="op">~</span> <span class="va">Days</span> <span class="op">+</span> <span class="op">(</span><span class="va">Days</span><span class="op">|</span><span class="va">Subject</span><span class="op">)</span>, <span class="va">sleepstudy</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Linear mixed model fit by REML ['lmerMod']</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Formula: Reaction ~ Days + (Days | Subject)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    Data: sleepstudy</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> REML criterion at convergence: 1743.628</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Random effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Groups   Name        Std.Dev. Corr</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Subject  (Intercept) 24.741       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           Days         5.922   0.07</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Residual             25.592       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of obs: 180, groups:  Subject, 18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fixed Effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)         Days  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      251.41        10.47  </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Fitting a generalized linear mixed model in six modularized steps</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## 1.  Parse the data and formula:</span></span></span>
<span class="r-in"><span><span class="va">glmod</span> <span class="op">&lt;-</span> <span class="fu">glFormula</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">incidence</span>, <span class="va">size</span> <span class="op">-</span> <span class="va">incidence</span><span class="op">)</span> <span class="op">~</span> <span class="va">period</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">herd</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                   data <span class="op">=</span> <span class="va">cbpp</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="co">#.... see what've got :</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">glmod</span>, max<span class="op">=</span><span class="fl">1</span>, give.attr<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> List of 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ fr     :'data.frame':	56 obs. of  3 variables:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ X      : num [1:56, 1:4] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ reTrms :List of 10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ family :List of 12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ formula:Class 'formula'  language cbind(incidence, size - incidence) ~ period + (1 | herd)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ wmsgs  : chr(0) </span>
<span class="r-in"><span><span class="co">## 2.  Create the deviance function for optimizing over theta:</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">devfun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">mkGlmerDevfun</span>, <span class="va">glmod</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> function (theta) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resp$updateMu(lp0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pp$setTheta(theta)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     p &lt;- pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GHrule(0L), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         compDev = compDev, maxit = maxit, verbose = verbose)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resp$updateWts()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     p</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x000001de4a9ce028&gt;</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span><span class="op">)</span> <span class="co"># the environment of devfun contains lots of info</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "compDev"     "lower"       "lp0"         "maxit"       "pp"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [6] "pwrssUpdate" "resp"        "tolPwrss"    "verbose"    </span>
<span class="r-in"><span><span class="co">## 3.  Optimize over theta using a rough approximation (i.e. nAGQ = 0):</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu">optimizeGlmer</span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameter estimates: 0.641838555348909 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> objective: 184.108693002453 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> number of function evaluations: 18 </span>
<span class="r-in"><span><span class="co">## 4.  Update the deviance function for optimizing over theta and beta:</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">devfun</span> <span class="op">&lt;-</span> <span class="fu">updateGlmerDevfun</span><span class="op">(</span><span class="va">devfun</span>, <span class="va">glmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> function (pars) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resp$setOffset(baseOffset)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resp$updateMu(lp0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pp$setTheta(as.double(pars[dpars]))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     spars &lt;- as.numeric(pars[-dpars])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     offset &lt;- if (length(spars) == 0) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         baseOffset</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else baseOffset + pp$X %*% spars</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resp$setOffset(offset)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     p &lt;- pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         compDev = compDev, grpFac = fac, maxit = maxit, verbose = verbose)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resp$updateWts()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     p</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x000001de4a9ce028&gt;</span>
<span class="r-in"><span><span class="co">## 5.  Optimize over theta and beta:</span></span></span>
<span class="r-in"><span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu">optimizeGlmer</span><span class="op">(</span><span class="va">devfun</span>, stage<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">opt</span>, max<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="co"># seeing what we'got</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> List of 7</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ fval       : num 184</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ par        : num [1:5] 0.642 -1.398 -0.992 -1.128 -1.58</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ convergence: num 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ NM.result  : int 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ message    : chr "parameter values converged to within tolerance"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ control    :List of 17</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ feval      : num 285</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "optimizer")= chr "Nelder_Mead"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "control")=List of 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "warnings")= list()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "derivs")=List of 2</span>
<span class="r-in"><span><span class="co">## 6.  Package up the results:</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">fMod</span> <span class="op">&lt;-</span> <span class="fu"><a href="mkMerMod.html">mkMerMod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span>, <span class="va">opt</span>, <span class="va">glmod</span><span class="op">$</span><span class="va">reTrms</span>, fr <span class="op">=</span> <span class="va">glmod</span><span class="op">$</span><span class="va">fr</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Approximation) [glmerMod]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Family: binomial  ( logit )</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      AIC      BIC   logLik deviance df.resid </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 194.0531 204.1799 -92.0266 184.0531       51 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Random effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Groups Name        Std.Dev.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  herd   (Intercept) 0.6421  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of obs: 56, groups:  herd, 15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fixed Effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)      period2      period3      period4  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     -1.3983      -0.9919      -1.1282      -1.5797  </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Same model in one line</span></span></span>
<span class="r-in"><span><span class="va">fM</span> <span class="op">&lt;-</span> <span class="fu"><a href="glmer.html">glmer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">incidence</span>, <span class="va">size</span> <span class="op">-</span> <span class="va">incidence</span><span class="op">)</span> <span class="op">~</span> <span class="va">period</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">herd</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>            data <span class="op">=</span> <span class="va">cbpp</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">fMod</span>, <span class="va">fM</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span>, tolerance <span class="op">=</span> <span class="fl">1e-12</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span>        <span class="co"># ----  --  even tolerance = 0  may work</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Douglas Bates, Martin Maechler, Ben Bolker, Steven Walker.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

